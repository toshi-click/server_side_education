# サーバサイドエンジニア教育用カリキュラム
この文書は、カタリストシステムで必須とされるPHPとその周辺技術の基礎を習得するための教育用カリキュラムです。  
受講者の能力によらず、必ず一通りのステップを実施していただきます。  
研修期間は約1ヶ月間を想定しています。  
すべてのステップを完了した時点で研修修了となります。

本カリキュラムでは、以下の登場人物を想定しています。

- 受講者 : 本カリキュラムの受講者です。
- メンター : 受講者の教育・指導・助言を行います。  
また、受講者と相談して仕様を一緒に決めたりする役割も担います。  
指導について、メンターがどの程度関与するかどうかはメンターの裁量に一任します。  
また、研修期間については、受講者のスキルレベルや社内の案件状況を考慮して、メンターの方であらかじめ目安を設定する予定です。

# 概要
## システムの要件
本カリキュラムでは、開発環境の作成後に課題として別途存在するPHP研修に沿った開発をしていただきます。  
PHP研修では、PHPの基礎的な使用法や、DB(データベース)と連携したWEBアプリケーションを作成します。

## サポートブラウザ
- Chrome最新版

## サーバーの構成について
下記のOS(オペレーティング・システム)・言語・ミドルウェアを使って構築していただきます。  
いずれも最新の安定バージョンを使用してください。
- VirtualBox
- CentOS
- PHP
- Apache HTTP Server
- PostgreSQL
- Ansible
- Docker

サーバーについては下記を利用してください。
- 開発
  - 自分のPC上の仮想マシン(以下VMとします)
- メンター確認環境
  - 自分のPC上のVM  
※ 性能要求は特に定めませんが、一般的な品質で作ってください。  
あまりにパフォーマンスが悪い場合は改善をしていただきます。  

# 本カリキュラムの最終目標
本カリキュラムの終了時点で、以下の項目を習得することを想定しています。
- PHPを利用した基本的なWebアプリケーションの実装ができるようになること
- Infrastructure as Codeを意識したサーバー構築ができるようになること
- 適切な検索語句でインターネット上の情報を検索できるようになること
- Linuxのセキュリティを考えたサーバー構築が出来るようになること
- PHPアプリケーションで一般的な環境を使ってアプリケーションを作成できること
- 作成したPHPアプリケーションに対して、機能の追加やデータのメンテナンスができること
- GitLabでMRをしてマージする一連の流れを習得すること。また、それに必要なGitのコマンドを習得すること
- 適切な粒度でコミットができること
- 適切にマージリクエスト（以下MR）の説明文が書けること
- レビューに対する対応と修正が一通りできること
- 不明な点を適切なタイミングでチームメンバーや関係者に（今回はメンターになります）口頭やチャットなどで質問ができること
 
# 課題ステップ
ステップ毎にMRを作成し、メンターに確認してもらう形とします

# ステップ1: 事前準備
#### 1-1 サーバ構築ツール事前準備
* [Vagrant準備手順](readme/vagrant_virtualbox.md)
* Git準備手順

# ステップ1: 基本設定を行おう
#### 1-1 Linuxの基本設定
- `kadai/step1`フォルダに`1-1.md`を作成してください。
- 設定したコマンド及び結果を上記ファイルに保存してください。また適切にコメントを付けてください。
- selinuxを無効化してください。
- タイムゾーンをコマンドで`Asia/Tokyo`に変更し、`date`コマンドで日本時間になっていることを確認してください。
- 言語設定をコマンドで日本語に変更し`localectl status`コマンドで`ja_JP.UTF-8`になっていることを確認してください。
- あなたの名前のユーザーを作成してください。
- あなたの名前のユーザーのパスワードを変更してください。
- カーネルパラメーターをチューニングしてください。
    - `net.core.somaxconn`を`65535`にしてください。
        - 備考：TCPソケットの接続要求キューのキャパシティ。
    - `net.ipv4.tcp_max_syn_backlog`を`65535`にしてください。
        - 備考：受け入れ可能なTCPセッション数
    - `net.core.netdev_max_backlog`を`16384`にしてください。
        - 備考：キューに繋げるパケット最大数
    - `net.ipv4.conf.all.forwarding`を`1`にしてください。
        - 備考：Dockerコンテナと外のネットワークのパケットのforwardingするために必要

#### 1-2 Linuxのセキュリティ設定
- `kadai/step1`フォルダに`1-2.md`を作成してください。
- 設定したコマンド及び結果を上記ファイルに保存してください。また適切にコメントを付けてください。
- `iptables`を`yum install`して下記のポート番号が開放されたファイアウォールの設定をしてください。
    - anuからの受信を許可
        - 22, 25, 80, 110, 443
    - ローカルネットワーク(`192.168.0.0/16`)からの受信を許可
        - 5432
- あなたの名前のユーザーがsudoを行えるように`/etc/sudoers.d/`へ適切にファイルを作成してください。
- `/etc/ssh/sshd_config`の設定変更を行い下記が行えないようにしてください
    - rootユーザーでのsshログイン
    - パスワード認証でのsshログイン

# ステップ2: PHPの開発環境を構築しよう
#### 2-1 Webサーバー(Apache HTTP Server)のインストール
- `kadai/step2`フォルダに`2-1.md`を作成してください。
- このステップで作成した手順は上記ファイル内に記述してください。また適切にコメントを付けてください。
- [公式ページ](https://httpd.apache.org/)より最新バージョンのソースコードをダウンロードしてインストールしてください  
- `httpd -v` コマンドでhttpdのバージョンが表示されることを確認してください
- `vagrant reload`を実行した際にhttpdが自動起動するようにしてください。
    - `ps`コマンドを使用して自動起動していることを確認してください。
- `ss -tnpl`コマンドを使用してhttpdが`80`ポートでLISTENしていることを確認してください。
- ブラウザで`http://vm.infra_training.cs.test`へアクセスし接続できることを確認してください。
    - index.html等をおいていない場合は`It's Work`が表示されるはずです。

#### 2-2 データベース（PostgreSQL）のインストール
- `kadai/step2`フォルダに`2-2.md`を作成してください
- このステップで作成した手順は上記ファイル内に記述してください。また適切にコメントを付けてください。
- [公式ページ](https://www.postgresql.org/)より最新バージョンのソースコードをダウンロードしてインストールしてください  
- `psql --version` コマンドでPostgreSQLのバージョンが表示されることを確認してください
- `vagrant reload`を実行した際にpostgresqlが自動起動するようにしてください。
    - `ps`コマンドを使用して自動起動していることを確認してください。
- `psql -U postgres`コマンドでpostgresに接続できることを確認してください。
- `ss -tnpl`コマンドを使用してPostgresqlが`5432`ポートでLISTENしていることを確認してください。

#### 2-3 PHPのインストール
- `kadai/step2`フォルダに`2-3.md`を作成してください
- このステップで作成した手順は上記ファイル内に記述してください。また適切にコメントを付けてください。
- [公式ページ](http://php.net/)より最新バージョンのソースコードをダウンロードしてインストールしてください  
- PHPからPostgreSQLへ接続できるようにインストールしてください  
- `php -v` コマンドでPHPのバージョンが表示されることを確認してください

# ステップ3: PHPの開発環境をセットアップしよう
#### 3-1 htmlを表示しよう
- リポジトリ内に`htdocs/kadai/step3_1`フォルダを作成してください
- 作成した`htdocs`フォルダ内に`hello world`と1文書いたHTMLファイルを作成してください
- Webサーバーの設定変更を行い、ブラウザからVMへアクセスし作成したHTMLファイルを表示できるようにしてください

#### 3-2 phpinfoを表示しよう
- この課題プロジェクト内の`htdocs/phpinfo.php`を`htdocs/kadai/step3_2`フォルダ内にコピーしてください
- WEBサーバー及びPHPの設定変更を行い、ブラウザからVMへアクセスしphpinfoが表示できるようにしてください
- phpinfoでpgsqlが表示されることを確認してください

ここまでで行なってきた内容は、どうだったでしょうか。とても多くのコマンドを実行することが必要で、コマンド実行忘れや、コマンドの打ち間違いが発生しうる内容になったかと思います。  
2000年代にはこのようなサーバー構築が一般的でしたが、2010年代の現在大部分を自動化することが出来るようになっています。  
そこで、これまで行なってきた内容をモダンに自動化してもらいます。  

# ステップ4: 環境設定自動化
#### 4-1 自動化準備
`vagrant destroy`コマンドを実行(もしくはVirtualboxのGUI画面から削除)しVMを削除してください。

#### 4-2 サーバー設定の自動化
- Vagrantの機能[ansible_local](https://www.vagrantup.com/docs/provisioning/ansible_local.html)で`playbook`を実行してタイムゾーン設定やロケールの設定をしてください
- `timedatectl`コマンドでタイムゾーンが`Asia/Tokyo`になっていることを確認してください
- `localectl status`コマンドで`ja_JP.UTF-8`になっていることを確認してください

#### 4-3 自動化ソフトウェアの自動インストール
- Vagrantの機能[ansible_local](https://www.vagrantup.com/docs/provisioning/ansible_local.html)で`playbook`を実行して`Docker`と`Docker-compose`をインストールしましょう
- `docker -v`コマンドでDockerバージョンが表示されることを確認してください
- `docker-compose -v`コマンドでDocker Composenoバージョンが表示されることを確認してください

# ステップ5: ミドルウェア構築自動化
#### 5-1 Webサーバー及びPHP実行環境のコンテナ化
- リポジトリ内に`docker`フォルダを作成してください
- 作成した`docker`フォルダ内に`apache`フォルダを作成してください
- 作成した`apache`フォルダ内に`Dockerfile`を作成してください
- [Dockerリファレンス](http://docs.docker.jp/engine/reference/builder.html)を参考に`Dockerfile`を作成し、Apache-PHP実行環境の構築を自動化してください
- ステップ3で作成したphpinfoを表示出来るようにしてください
- 使用するベースコンテナは`centos:latest`とします

#### 5-2 データベース（PostgreSQL）のコンテナ化
- リポジトリ内の`docker`フォルダ内に`postgres`フォルダを作成してください
- 作成した`apache`フォルダ内に`Dockerfile`を作成してください
- 5-1と同様にリファレンスを参考にデータベースサーバーの構築を自動化してください
- 使用するベースコンテナは`centos:latest`とします

#### 5-3 WEBサーバーコンテナとデータベースコンテナを連携させる
- WEBサーバーからデータベースコンテナにアクセスが出来るようにする
- `docker run`コマンドを使用して2つのコンテナを連携出来るようにすること
- `docker exec -it [WEBサーバーコンテナ名] /bin/bash`でWEBサーバーコンテナに入り、`psql`コマンドでデータベースコンテナにアクセス出来ることを確認する
- ブラウザから`htdocs/index.php`へアクセスし、データベースがPHP経由で操作出来るようにする。
    - ここで必要なconfは`htdocs/lib/Conf.inc`です。データベース名などは適宜修正してください。
 
#### 5-4 docker-composeで`docker run`を定義する
- リポジトリ内の`docker`フォルダ内に`docker-compose.yml`ファイルを作成してください
- [Docker Composeリファレンス](http://docs.docker.jp/compose/compose-file.html)を参考にWEBサーバーコンテナとデータベースコンテナを定義してください
- `docker-compose up -d`コマンドでコンテナが起動し、連携できていることを確認してください

